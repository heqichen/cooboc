<html>
	<head>
		<title>Head Position Detect for Faurecia</title>
		<script type="text/javascript" src="/static/jquery-1.11.2.min.js"></script>
		<script language="javascript" type="text/javascript" src="/static/jquery.jqplot.min.js"></script>
		<script type="text/javascript" src="/static/jqplot.canvasTextRenderer.min.js"></script>
		<script type="text/javascript" src="/static/jqplot.canvasAxisLabelRenderer.min.js"></script>
		<link rel="stylesheet" type="text/css" href="/static/jquery.jqplot.css" />
<script>


var lowTemp = 15.0;
var highTemp = 40.0;
var threshold = 30.0;

var map = function(x, in_min, in_max, out_min, out_max) {
	x = parseFloat(x);
	in_min = parseFloat(in_min);
	in_max = parseFloat(in_max);
	out_min = parseFloat(out_min);
	out_max = parseFloat(out_max);
	return (x - in_min) * (out_max - out_min) / (in_max - in_min) + out_min;
}

var constraint = function(x, in_min, in_max) {
	if (x < in_min) {
		x = in_min;
	}
	if (x > in_max) {
		x = in_max;
	}
	return x;
}


$(document).ready(function() {
	var firCell = [];
	var filteredCell = [];
	var x, y;
	for (y=0; y<4; ++y) {
		for (x=0; x<16; ++x)
		{
			firCell[y*16 + x] = $("<div>", {"id":"fir_cell_" + Number(y*16+x),"class":"fir_cell" })
				.offset({"top": Number(y*50), "left": Number(x*100)})
				.appendTo($("#wrapper"));
			filteredCell[y*16 + x] = $("<div>", {"id":"filtered_cell_" + Number(y*16+x),"class":"fir_cell" })
				.offset({"top": Number(y*50), "left": Number(x*100)})
				.appendTo($("#filtered_wrapper"));
		}
	}

	$("#lowTemp").on("change", function(){
		lowTemp = $("#lowTemp").val();
	});
	$("#highTemp").on("change", function(){
		highTemp = $("#highTemp").val();
	});
	$("#threshold").on("change", function() {
		threshold = $("#threshold").val();
		$("#threshold-text").text(threshold);
	});

	var sortArray = function(ulist) {
		var alist = [];
		var i, j;
		for (i=0; i<ulist.length; ++i)
		{
			alist[i] = ulist[i];
		}

		alist.sort();
		

		return alist;
	}

	var plotChart = $.jqplot("plot_wrapper", [[0]]);


	var filterCell = [];
	var cellQ = 0.8;

	var i;
	for (i=0; i<64; ++i) {
		filterCell[i] = 0.0;
	}

	var renderGrpah = function(dataList) {
		//alert(data.firArray);
		var i;
		for (i=0; i<64; ++i) {

			filterCell[i] = cellQ * filterCell[i] + (1.0 - cellQ) * dataList[i];

			firCell[i].text(filterCell[i].toFixed(2));
			r = map(filterCell[i], lowTemp, highTemp, 0.0, 255.0);
			r = constraint(r, 0, 255);
			g = 0.0;
			b = map(filterCell[i], lowTemp, highTemp, 255.0, 0.0);
			b = constraint(b, 0, 255);

			firCell[i].css("background-color", "rgb(" + parseInt(r) + "," + parseInt(g) + "," + parseInt(b) + ")");

			if (filterCell[i] > threshold) {
				filteredCell[i].css("background-color", "white");
			} else {
				filteredCell[i].css("background-color", "gray");
			}
		}
	};

	var filterDiff = 0;
	var diffQ = 0.8;

	var DIFF_THRESHOLD = 5.0;
	var CELL_DIFF_THRESHOLD = 2.5;



	var processData = function(dataList) {
		var olist = sortArray(dataList);


		//consider only from olist[2] to olist[61];
		var i;
		var conList = [];
		var x, y;
		for (i=2; i<62; ++i) {
			conList[i-2] = olist[i];
		}

		plotChart.destroy();
		//console.log(olist);
		plotChart = $.jqplot("plot_wrapper", [conList], {axes: {yaxis:{min:15, max:40}}});

		var minIr = conList[0];
		var maxIr = conList[59];


		var diff = (maxIr - minIr);

		var headInRow = [];

		/*
		filterDiff = diffQ * filterDiff + (1.0 - diffQ) * diff;
		for (y=0; y<4; ++y) {
			for (x=0; x<16-1; ++x) {
				if ((filterCell[y*16+x+1]-filterCell[y*16+x] > CELL_DIFF_THRESHOLD) && filterCell[y*16+x+1] > olist[4]+CELL_DIFF_THRESHOLD) {
					headInRow[y] = x+1;
					break;
				}
				if (headInRow[y] == undefined) {
					headInRow[y] = 100; //this is a magic number
				}
			}

		}
*/

		$("#min-temp-text").text(minIr);
		$("#max-temp-text").text(maxIr);
		$("#temp-diff-text").text(diff);
		$("#filtered-diff-text").text(filterDiff);
		if (filterDiff > DIFF_THRESHOLD) {
			$("#filtered-diff-text").css("background-color", "red");
			$("#filtered-diff-text").css("color", "white");
			$("#head-in-row0").text(headInRow[0]);
			$("#head-in-row1").text(headInRow[1]);
			$("#head-in-row2").text(headInRow[2]);
			$("#head-in-row3").text(headInRow[3]);
		} else {
			$("#filtered-diff-text").css("background-color", "white");
			$("#filtered-diff-text").css("color", "black");
		}

	};

	var onNewFirArray = function(data, textStatus, jqXHR) {
		renderGrpah(data.firArray);
		processData(data.firArray);

	};

	var updateData = function() {
		$.ajax({
			url: "/getFirArray", 
			dataType: "json", 
			method: "GET", 
			success: onNewFirArray
		});
	};



	setInterval(updateData, 200);


	


});
</script>
<style>
#wrapper
{
	position:	relative;
	width:	1600px;
	height:	200px;
	display:	inline-block;
}

#filtered_wrapper
{
	position:	relative;
	width:	1600px;
	height:	200px;
	display:	inline-block;
}

#plot_wrapper
{
	width:	1600px;
	height:	200px;
}

.fir_cell
{
	position: absolute;
	width:	100px;
	height:	50px;
	display: block;
	text-align:	center;
	font-weight: bold;
	color:	white;
}


</style>
	</head>
	<body>
		<div id="wrapper">&nbsp;</div> <br />
		<div id="control_panel">
			Low Temperature: <input type="text" value="15.0" id="lowTemp"/>, High Temperature: <input type="text" value="40.0" id="highTemp"/> <br />
			Threshold: <input type="range" id="threshold" value="30.0" min="20" max="35" step="0.1" for="threshold-text"/><span id="threshold-text">30.0</span><br />


		</div><br />
		<div id="filtered_wrapper">&nbsp;</div> <br/ >

		<div id="plot_wrapper">&nbsp;</div> <br />

		MinTemp: <span id="min-temp-text">N/A</span> &nbsp;&nbsp;&nbsp;&nbsp;
		MaxTemp: <span id="max-temp-text">N/A</span> &nbsp;&nbsp;&nbsp;&nbsp;
		TempDiff: <span id="temp-diff-text">N/A</span> &nbsp;&nbsp;&nbsp;&nbsp;
		Diff: <span id="filtered-diff-text">N/A</span><br />
		<h3>Head Position</h3>
		Row1: <span id="head-in-row0">N/A</span><br />
		Row2: <span id="head-in-row1">N/A</span><br />
		Row3: <span id="head-in-row2">N/A</span><br />
		Row4: <span id="head-in-row3">N/A</span><br />



	</body>
</html>
